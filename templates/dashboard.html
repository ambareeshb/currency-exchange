{% extends "base.html" %}

{% block title %}Dashboard - Currency Exchange Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt me-2"></i>Currency Management Dashboard</h2>
        <p class="text-muted">Manage currency exchange rates to and from UAE Dirham (AED)</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus me-2"></i>Add New Currency</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_currency') }}">
                    <div class="mb-3">
                        <label for="name" class="form-label">Currency Name</label>
                        <input type="text" class="form-control" id="name" name="name"
                               placeholder="e.g., US Dollar"
                               value="{{ form_data.get('name', '') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="symbol" class="form-label">Symbol</label>
                        <input type="text" class="form-control" id="symbol" name="symbol"
                               placeholder="e.g., USD" maxlength="10"
                               value="{{ form_data.get('symbol', '') }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Buying Rate Range (Exchange buys currency from customer)</label>
                        <div class="row">
                            <div class="col-6">
                                <label for="min_buying_rate_to_aed" class="form-label text-success">Min Buying Rate</label>
                                <input type="number" class="form-control" id="min_buying_rate_to_aed" name="min_buying_rate_to_aed"
                                       step="0.000001" placeholder="e.g., 3.65"
                                       value="{{ form_data.get('min_buying_rate_to_aed', '') }}">
                                <small class="text-muted">Minimum rate when exchange buys</small>
                            </div>
                            <div class="col-6">
                                <label for="max_buying_rate_to_aed" class="form-label text-success">Max Buying Rate</label>
                                <input type="number" class="form-control" id="max_buying_rate_to_aed" name="max_buying_rate_to_aed"
                                       step="0.000001" placeholder="e.g., 3.67"
                                       value="{{ form_data.get('max_buying_rate_to_aed', '') }}">
                                <small class="text-muted">Maximum rate when exchange buys</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Selling Rate Range (Exchange sells currency to customer)</label>
                        <div class="row">
                            <div class="col-6">
                                <label for="min_selling_rate_to_aed" class="form-label text-danger">Min Selling Rate</label>
                                <input type="number" class="form-control" id="min_selling_rate_to_aed" name="min_selling_rate_to_aed"
                                       step="0.000001" placeholder="e.g., 3.68"
                                       value="{{ form_data.get('min_selling_rate_to_aed', '') }}">
                                <small class="text-muted">Minimum rate when exchange sells</small>
                            </div>
                            <div class="col-6">
                                <label for="max_selling_rate_to_aed" class="form-label text-danger">Max Selling Rate</label>
                                <input type="number" class="form-control" id="max_selling_rate_to_aed" name="max_selling_rate_to_aed"
                                       step="0.000001" placeholder="e.g., 3.70"
                                       value="{{ form_data.get('max_selling_rate_to_aed', '') }}">
                                <small class="text-muted">Maximum rate when exchange sells</small>
                            </div>
                        </div>
                        <div class="form-text">Set rate ranges for exchange operations. Overlapping rates are allowed for flexible pricing.</div>
                    </div>
                    <div class="mb-3">
                        <label for="admin_notes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="admin_notes" name="admin_notes" rows="3"
                                  placeholder="Add notes about this currency (visible to public via info button)">{{ form_data.get('admin_notes', '') }}</textarea>
                        <div class="form-text">These notes will be visible to users via the info button</div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus me-2"></i>Add Currency
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list me-2"></i>Existing Currencies</h5>
            </div>
            <div class="card-body">
                {% if currencies %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Symbol <i class="fas fa-sort-alpha-down text-muted"></i></th>
                                <th>Name</th>
                                <th>Admin Rates</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for currency in currencies %}
                            <tr>
                                <td><strong>{{ currency.symbol }}</strong></td>
                                <td>{{ currency.name }}</td>
                                <td class="currency-rate">
                                    {% if currency.has_exchange_rates %}
                                        <div class="d-flex flex-column">
                                            <span class="text-success">Buy: {{ currency.buying_rate_display }}</span>
                                            <span class="text-danger">Sell: {{ currency.selling_rate_display }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No rates set</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if currency.admin_notes %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-sticky-note text-info me-2" title="Has notes"></i>
                                            {% if currency.notes_updated_at %}
                                                <small class="text-muted"
                                                       title="{{ currency.notes_updated_at.strftime('%B %d, %Y at %I:%M:%S %p UTC') }}"
                                                       style="cursor: help;">
                                                    <span class="relative-time" data-timestamp="{{ currency.notes_updated_at.isoformat() }}">
                                                        <!-- Will be populated by JavaScript -->
                                                    </span>
                                                </small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <i class="fas fa-sticky-note text-muted" title="No notes"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editModal{{ currency.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal{{ currency.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-coins fa-3x mb-3"></i>
                    <p>No currencies added yet. Add your first currency using the form on the left.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Modals -->
{% for currency in currencies %}
<div class="modal fade" id="editModal{{ currency.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit {{ currency.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_currency', currency_id=currency.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name{{ currency.id }}" class="form-label">Currency Name</label>
                        <input type="text" class="form-control" id="edit_name{{ currency.id }}"
                               name="name" value="{{ currency.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Buying Rate Range (Exchange buys currency from customer)</label>
                        <div class="row">
                            <div class="col-6">
                                <label for="edit_min_buying_rate{{ currency.id }}" class="form-label text-success">Min Buying Rate</label>
                                <input type="number" class="form-control" id="edit_min_buying_rate{{ currency.id }}"
                                       name="min_buying_rate_to_aed" value="{{ currency.min_buying_rate_to_aed or '' }}"
                                       step="0.000001" placeholder="Minimum buying rate">
                                <small class="text-muted">Minimum rate when exchange buys</small>
                            </div>
                            <div class="col-6">
                                <label for="edit_max_buying_rate{{ currency.id }}" class="form-label text-success">Max Buying Rate</label>
                                <input type="number" class="form-control" id="edit_max_buying_rate{{ currency.id }}"
                                       name="max_buying_rate_to_aed" value="{{ currency.max_buying_rate_to_aed or '' }}"
                                       step="0.000001" placeholder="Maximum buying rate">
                                <small class="text-muted">Maximum rate when exchange buys</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Selling Rate Range (Exchange sells currency to customer)</label>
                        <div class="row">
                            <div class="col-6">
                                <label for="edit_min_selling_rate{{ currency.id }}" class="form-label text-danger">Min Selling Rate</label>
                                <input type="number" class="form-control" id="edit_min_selling_rate{{ currency.id }}"
                                       name="min_selling_rate_to_aed" value="{{ currency.min_selling_rate_to_aed or '' }}"
                                       step="0.000001" placeholder="Minimum selling rate">
                                <small class="text-muted">Minimum rate when exchange sells</small>
                            </div>
                            <div class="col-6">
                                <label for="edit_max_selling_rate{{ currency.id }}" class="form-label text-danger">Max Selling Rate</label>
                                <input type="number" class="form-control" id="edit_max_selling_rate{{ currency.id }}"
                                       name="max_selling_rate_to_aed" value="{{ currency.max_selling_rate_to_aed or '' }}"
                                       step="0.000001" placeholder="Maximum selling rate">
                                <small class="text-muted">Maximum rate when exchange sells</small>
                            </div>
                        </div>
                        <div class="form-text">Set rate ranges for exchange operations. Overlapping rates are allowed for flexible pricing.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes{{ currency.id }}" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="edit_notes{{ currency.id }}" name="admin_notes" rows="3"
                                  placeholder="Add notes about this currency">{{ currency.admin_notes or '' }}</textarea>
                        <div class="form-text">These notes will be visible to users via the info button</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Currency</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Modals -->
{% for currency in currencies %}
<div class="modal fade" id="deleteModal{{ currency.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete {{ currency.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ currency.name }} ({{ currency.symbol }})</strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_currency', currency_id=currency.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Currency</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
// Relative time utility functions
function getRelativeTime(dateString) {
    if (!dateString) return null;
    
    const now = new Date();
    // Ensure the date string is properly parsed as UTC
    let date;
    if (dateString.endsWith('Z') || dateString.includes('+') || dateString.includes('T') && dateString.includes(':')) {
        // Already has timezone info
        date = new Date(dateString);
    } else {
        // Assume UTC if no timezone info
        date = new Date(dateString + 'Z');
    }
    
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return diffInSeconds <= 1 ? '1 second ago' : `${diffInSeconds} seconds ago`;
    }
    
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    if (diffInMinutes < 60) {
        return diffInMinutes === 1 ? '1 minute ago' : `${diffInMinutes} minutes ago`;
    }
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) {
        return diffInHours === 1 ? '1 hour ago' : `${diffInHours} hours ago`;
    }
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays <= 4) {
        return diffInDays === 1 ? '1 day ago' : `${diffInDays} days ago`;
    }
    
    // For dates older than 4 days, return null to show exact date
    return null;
}

function formatExactTime(dateString) {
    if (!dateString) return 'No timestamp available';
    
    // Ensure the date string is properly parsed as UTC
    let date;
    if (dateString.endsWith('Z') || dateString.includes('+') || dateString.includes('T') && dateString.includes(':')) {
        // Already has timezone info
        date = new Date(dateString);
    } else {
        // Assume UTC if no timezone info
        date = new Date(dateString + 'Z');
    }
    
    return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZoneName: 'short'
    });
}

// Update relative time displays
function updateRelativeTimes() {
    document.querySelectorAll('.relative-time').forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (timestamp) {
            const relativeTime = getRelativeTime(timestamp);
            const exactTime = formatExactTime(timestamp);
            
            if (relativeTime) {
                element.textContent = relativeTime;
                element.setAttribute('title', exactTime);
            } else {
                // For dates older than 4 days, show the exact date
                const date = new Date(timestamp);
                element.textContent = date.toLocaleDateString();
                element.setAttribute('title', exactTime);
            }
        }
    });
}

// Initialize relative times when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateRelativeTimes();
    
    // Update every minute
    setInterval(updateRelativeTimes, 60000);
});
</script>

{% endblock %}